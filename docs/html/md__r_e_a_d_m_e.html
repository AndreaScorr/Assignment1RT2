<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Assignment2: Research track 1 Second assignment</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Assignment2
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Research track 1 Second assignment </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Andrea Scorrano</p>
<p>id: 6463777</p>
<p>Create a new package, in which you will develop three nodes:</p><ul>
<li>(a) A node that implements an action client, allowing the user to set a target (x, y) or to cancel it. Try to use the feedback/status of the action server to know when the target has been reached. The node also publishesthe robot position and velocity as a custom message (x,y, vel_x, vel_z), by relying on the values published on the topic /odom;</li>
<li>(b) A service node that, when called, returnsthe coordinates of the last target sent by the user;</li>
<li>(c) Anotherservice node thatsubscribes to the robot’s position and velocity (using the custom message) and implements a server to retrieve the distance of the robot from the target and the robot’s average speed.</li>
</ul>
<h1><a class="anchor" id="autotoc_md0"></a>
How to Run the code</h1>
<p>In order to start the whole simulation, open three terminals. To run the simulation of the enviroment, it's needed to write le following line:</p>
<div class="fragment"><div class="line"># roslaunch assignment_2_2023 assignment1.launch</div>
</div><!-- fragment --><p>To run the three nodes using the launch file, it's needed to write le following line, specifying the window size of the average, in this case 3:</p>
<div class="fragment"><div class="line"># roslaunch assignment_2_2023 AndreaScorrano.launch des_window:=3</div>
</div><!-- fragment --><p>To retrieve the distance of the robot from the target and the robot’s average speed, it's needed to call the service with the following line:</p>
<div class="fragment"><div class="line"># rosservice call /VelocityDistance </div>
</div><!-- fragment --><p>The last line must be runned every time it's needed to know the distance of the robot from the target and the robot’s average speed.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Pseudocode and Flow Charts</h1>
<p>In this assignment were implemented three nodes. The following flow charts show how each node works.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
setTarget Node</h2>
<p>This node that implements an action client, allow the user to set a target (x, y) or to cancel it. Has been used the feedback/status of the action server to know when the target has been reached. The node also publishes the robot position and velocity as a custom message (x,y, vel_x, vel_z), by relying on the values published on the topic /odom. </p><div class="fragment"><div class="line">Initialize pos_x, pos_y, vel_x, vel_z as global variables</div>
<div class="line">Initialize feedback as a string</div>
<div class="line">Initialize g_shutdown_requested as a boolean (false)</div>
<div class="line"> </div>
<div class="line">Function odomCallback(msg):</div>
<div class="line">    Print position and velocity information from /odom</div>
<div class="line">    Assign position and velocity values to global variables pos_x, pos_y, vel_x, vel_z</div>
<div class="line"> </div>
<div class="line">Function feedbackCallBack(msg):</div>
<div class="line">    Assign the value of feedback to feedback</div>
<div class="line"> </div>
<div class="line">Function shutdownHandler(sig):</div>
<div class="line">    Print &quot;Shutting down...&quot;</div>
<div class="line">    Set g_shutdown_requested to true</div>
<div class="line"> </div>
<div class="line">Main:</div>
<div class="line">    Initialize ROS node (&quot;Planning&quot;)</div>
<div class="line">    Create a SimpleActionClient for the action assignment_2_2023::PlanningAction</div>
<div class="line">    Wait for the action server to start</div>
<div class="line">    Initialize a goal of type assignment_2_2023::PlanningGoal</div>
<div class="line"> </div>
<div class="line">    Prompt the user to enter the x position of the goal</div>
<div class="line">    Prompt the user to enter the y position of the goal</div>
<div class="line">    Print a message indicating to press ctrl-c to cancel the goal</div>
<div class="line">    Wait for 3 seconds to display the message</div>
<div class="line"> </div>
<div class="line">    Send the goal to the action</div>
<div class="line"> </div>
<div class="line">    Create subscribers for the &quot;odom&quot; and &quot;/reaching_goal/feedback&quot; topics and a publisher for &quot;robot/parameters&quot;</div>
<div class="line">    Set up a handler for handling shutdown using ctrl-c</div>
<div class="line"> </div>
<div class="line">    Loop while ROS is active and g_shutdown_requested is false:</div>
<div class="line">        Create a message of type assignment_2_2023::Parameters</div>
<div class="line">        Assign the current values of position and velocity to the variables of the message</div>
<div class="line">        Publish the message</div>
<div class="line"> </div>
<div class="line">        Get the state of the action</div>
<div class="line">        If the feedback is &quot;Target reached!&quot;, exit the loop</div>
<div class="line"> </div>
<div class="line">        Run the ROS spin loop to handle callbacks</div>
<div class="line"> </div>
<div class="line">    Cancel the action goal when the loop ends or the target is reached</div>
<div class="line"> </div>
<div class="line">End the program</div>
</div><!-- fragment --><p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/8eac8264-e023-4582-9e70-fcd4095e04f8" alt="setTargetNode" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md3"></a>
lastTargetService node</h2>
<p>This is a service node that, when called, returns the coordinates of the last target sent by the user. </p><div class="fragment"><div class="line">Function lastTarget(req, res):</div>
<div class="line">    # Get the desired positions from topics and put them in the result argument of the service</div>
<div class="line">    </div>
<div class="line">    res.target_pose.pose.position.x = get(&quot;/des_pos_x&quot;)</div>
<div class="line">    res.target_pose.pose.position.y = get(&quot;/des_pos_y&quot;)</div>
<div class="line"> </div>
<div class="line">    Print &quot;return x:&quot;, res.target_pose.pose.position.x, &quot;y:&quot;, res.target_pose.pose.position.y</div>
<div class="line">    Return true</div>
<div class="line"> </div>
<div class="line">Main:</div>
<div class="line">    Initialize ROS node (&quot;lastTarget_&quot;)</div>
<div class="line">    Create a NodeHandle</div>
<div class="line">    Initialize a ServiceServer with the lastTarget function as the callback for the &quot;/lastTarget&quot; service</div>
<div class="line">    Enter the ROS spin loop</div>
<div class="line"> </div>
<div class="line">    # The program will stay in the spin loop, waiting for service requests</div>
<div class="line"> </div>
<div class="line">    Return 0</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4"></a>
positionAndVelocitySubscriber node</h2>
<p>This service node subscribes to the robot’s position and velocity (using the custom message) and implements a server to retrieve the distance of the robot from the target and the robot’s average speed.</p>
<div class="fragment"><div class="line">Initialize pos_x, pos_y, vel_x, vel_z as global variables</div>
<div class="line">Initialize lastTarget as an instance of assignment_2_2023::LastTarget</div>
<div class="line">Initialize lastPosition_x, lastPosition_y as variables for the last target position</div>
<div class="line">Initialize windowSize, sumVel_x, sumVel_z, i, average_vel_x, average_vel_z as variables for averaging</div>
<div class="line">Initialize dist_x, dist_y as variables for the distance calculation</div>
<div class="line"> </div>
<div class="line">Function parameterCallback(msg):</div>
<div class="line">    Assign values from the message to pos_x, pos_y, vel_x, vel_z</div>
<div class="line">    Calculate dist_x and dist_y based on the difference between pos_x, pos_y, and lastPosition_x, lastPosition_y</div>
<div class="line"> </div>
<div class="line">Function VelocityAndDistance(req, res):</div>
<div class="line">    Set res.dist_x, res.dist_y to dist_x, dist_y</div>
<div class="line">    Set res.average_x, res.average_z to average_vel_x, average_vel_z</div>
<div class="line">    Print distance from target x, distance from target y, average velocity x, average velocity z</div>
<div class="line">    Return true</div>
<div class="line"> </div>
<div class="line">Main:</div>
<div class="line">    Initialize ROS node (&quot;listener&quot;)</div>
<div class="line">    Create a NodeHandle</div>
<div class="line">    Create a ServiceClient for &quot;/lastTarget&quot;</div>
<div class="line">    Create a ServiceServer for &quot;/VelocityDistance&quot; with VelocityAndDistance as the callback</div>
<div class="line"> </div>
<div class="line">    Wait for the service client to exist</div>
<div class="line">    Call the lastTarget service and store the results in lastPosition_x, lastPosition_y</div>
<div class="line">    Get the windowSize from the parameter server</div>
<div class="line"> </div>
<div class="line">    Create a subscriber for the &quot;robot/parameters&quot; topic with parameterCallback as the callback</div>
<div class="line"> </div>
<div class="line">    Loop while ROS is active:</div>
<div class="line">        Accumulate velocities in sumVel_x, sumVel_z</div>
<div class="line">        Increment i</div>
<div class="line"> </div>
<div class="line">        If i equals windowSize:</div>
<div class="line">            Calculate average velocities and reset accumulators</div>
<div class="line">            Set i to 0</div>
<div class="line"> </div>
<div class="line">        Run the ROS spin loop to handle callbacks</div>
<div class="line"> </div>
<div class="line">    Return 0</div>
</div><!-- fragment --><p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/6126baac-d393-4de9-b2f1-33e7e1fb104e" alt="Node3 drawio" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md5"></a>
Simulation of the assignment</h1>
<p>To setup the environment is needed to launch assignment1.launch</p>
<p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/d99a8ada-260e-4734-a1fa-fd1348bf01cd" alt="Screenshot 2024-01-11 112910" class="inline"/></p>
<hr  />
<p>Once done, will be opened Gazebo and Rviz, with the environment.</p>
<p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/73e0f8a0-6cd6-4909-93cf-77f111e9b771" alt="Screenshot 2024-01-11 113109" class="inline"/></p>
<hr  />
<p>To run the three nodes using the launch file, it's needed to write le following line, specifying the window size of the average, in this case 3:</p>
<div class="fragment"><div class="line"># roslaunch assignment_2_2023 AndreaScorrano.launch des_window:=3</div>
</div><!-- fragment --><p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/20665620-b7f7-46ea-a6be-4fee966c9318" alt="Screenshot 2024-01-11 113349" class="inline"/></p>
<p>Once started the node, will be asked to the user the position x and y of the goal. Will be shown a message that specify to the user to press ctr-c to cancel the goal (has been used ros::Duration(3.0).sleep() to give the user the possibility to see the message)</p>
<p>In case ctrl-c is pressed the goal is cancelled and on the terminal where assignment1.launch was launched will be shown the following result:</p>
<p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/108ce4fd-28cc-493e-8c79-536735b07718" alt="Screenshot 2024-01-11 113428" class="inline"/></p>
<hr  />
<p>To retrieve the distance of the robot from the target and the robot’s average speed while the robot is reaching the goal, it's needed to call the service with the following line:</p>
<div class="fragment"><div class="line"># rosservice call /VelocityDistance </div>
</div><!-- fragment --><p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/09928a1f-704b-4fd6-a23a-8d10e9bd306b" alt="rosservice" class="inline"/></p>
<hr  />
<p>Once the robot reached the goal position, in the therminal where assignment2.launch were launched it's possible to see the message "Goal succeded!":</p>
<p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/b1659d2b-d170-4837-b28b-ac77f2170c1b" alt="goalS3" class="inline"/></p>
<p>In the terminal where AndreaScorrano.launch where launched it's possible to see the following result:</p>
<p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/e6ac3519-d4a9-43b7-afe2-9feda9d43ecf" alt="goalS2" class="inline"/></p>
<p>On Gazebo is possible to see that the robot reached the goal, in this case the desired position where x=5 and y=6:</p>
<p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/8cc4d6bc-e2f0-4c86-925f-1fde1c271979" alt="goalS" class="inline"/></p>
<hr  />
<p> In order to have a view of what happens bebehind the scenes is needed to run the following command on the terminal: </p><div class="fragment"><div class="line"># rosrun rqt_graph rqt_graph</div>
</div><!-- fragment --><p>It's possible to see isualize the communication between the nodes.</p>
<p><img src="https://github.com/AndreaScorr/ResearchTrackAssignment2AndreaScorrano/assets/40230364/d51586b3-86fe-4835-a208-0c880dea26fa" alt="rosgraph" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
